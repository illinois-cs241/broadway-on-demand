<script type="application/javascript">
    function updateButtonContent(runId, text, buttonType) {
        $("#status-" + runId).html("<i class=\"fas fa-sync-alt\"></i> " + text)
                             .attr("class", "btn btn-secondary btn-sm btn-text-break " + buttonType);
    }

    function buildHeader(token) {
        return { Authorization: `Bearer ${token}` };
    }

    function getRunState(runId, cid, queryToken) {
        $.ajax({
            type: "get",
            url: `{{ broadway_api_url }}/grading_run_status/${cid}/${runId}`,
            headers: buildHeader(queryToken),
                success: (result) => {
                let status = result["data"]["state"]
                if (status.indexOf("scheduled") != -1) {
                    updateButtonContent(runId, status, "btn-info")
                } else {
                    updateButtonContent(runId, status, "btn-success")
                }
            },
            error: () => {
                updateButtonContent(runId, "Unknown. Click to try again", "btn-warning");
            }
        })
    }

    function getRunStatus(runId, cid, queryToken) {
        $.ajax(
            {
                type: "get",
                url: `{{ broadway_api_url }}/grading_run_status/${cid}/${runId}`,
                headers: buildHeader(queryToken),
                success: function (result) {
                    let status = Object.values(result["data"]["student_jobs_state"])[0]
                    let jobId = Object.keys(result["data"]["student_jobs_state"])[0]
                    var status_map = {
                        "scheduled": "btn-info",
                        "running": "btn-info",
                        "success": "btn-success",
                        "failed": "btn-danger",
                        "": "btn-info"
                    };

                    for (var key in status_map) {
                        if (status.indexOf(key) != -1) {
                            if (key == "scheduled") {
                                getQueuePosition(runId, jobId, cid, queryToken);
                            } else {
                                updateButtonContent(runId, status, status_map[key]);
                            }
                            break;
                        }
                    }
                },
                error: function () {
                    updateButtonContent(runId, "Unknown. Click to try again.", "btn-warning");
                }
            })
    }

    function getQueuePosition(runId, jobId, cid, queryToken) {
        $.ajax(
            {
                type: "get",
                url: `{{ broadway_api_url }}/queue/${cid}/${jobId}/position`,
                headers: buildHeader(queryToken),
                success: function (result) {
                    let position = result["data"]["position"]
                    let queuePositionString = "Your job is scheduled after " + position + " other jobs";
                    if (position == "0") {
                        queuePositionString = "Your job is next";
                    }
                    updateButtonContent(runId, queuePositionString, "btn-info");
                },
                error: function () {
                    updateButtonContent(runId, "Your run is scheduled. Queue position unknown.", "btn-info");
                }
            }
        )
    }
</script>
